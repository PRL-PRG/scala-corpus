MAKEFLAGS += --no-builtin-rules

.SUFFIXES:

# absolute path to the ivy directory that contains cache and local subdirs
ifndef GLOBAL_IVY_DIR
$(error GLOBAL_IVY_DIR is not set. Typically ~/.ivy2)
endif

# absolute path to the prepopulated sbt-boot directory
ifndef GLOBAL_SBT_BOOT_DIR
$(error GLOBAL_SBT_BOOT_DIR is not set. Typically ~/.sbt/boot)
endif

# level of concurrency
ifndef N_JOBS
$(error N_JOBS is not set. Controls the number of parallel jobs)
endif

# level of concurrency
#ifndef CORPUS_DIR
#$(error CORPUS_DIR is not set. Controls which corpus shall be used)
#endif

SBT_MEM ?= 16000
TIMEOUT ?= 30m

ANALYSIS_DIR := _analysis_
IVY_DIR := .ivy
SBT_BOOT_DIR := .sbt-boot
SEMANTICDB_STATUS := $(ANALYSIS_DIR)/semanticdb-status.csv
SEMANTICDB_LOG := $(ANALYSIS_DIR)/semanticdb.log
METADATA_STATUS := $(ANALYSIS_DIR)/metadata-status.csv
METADATA_LOG := $(ANALYSIS_DIR)/metadata.log
REPO_METADATA := $(ANALYSIS_DIR)/repo-metadata.csv
IMPLICITS := $(ANALYSIS_DIR)/implicits.bin
IMPLICITS_STATUS := $(ANALYSIS_DIR)/implicits-status.csv
IMPLICITS_LOG := $(ANALYSIS_DIR)/implicits.log

AMM := JAVA_OPTS="-Xmx$(SBT_MEM)m" amm

$(IVY_DIR):
	mkdir -p $(IVY_DIR)
	ln -sf $(GLOBAL_IVY_DIR)/cache $(IVY_DIR)
	ln -sf $(GLOBAL_IVY_DIR)/local $(IVY_DIR)

$(SBT_BOOT_DIR):
	mkdir -p $(SBT_BOOT_DIR)
	ls -1 $(GLOBAL_SBT_BOOT_DIR) |\
        grep "^scala-" |\
        parallel ln -sf "$(GLOBAL_SBT_BOOT_DIR)/{1}" "$(SBT_BOOT_DIR)/${1}"

