MAKEFLAGS += --no-builtin-rules

.SUFFIXES:

HOSTNAME := $(shell hostname)
USERNAME := $(shell id -un)
base_dir := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))
include $(base_dir)/Makevars-$(USERNAME)@$(HOSTNAME)

# absolute path to the ivy directory that contains cache and local subdirs
ifndef GLOBAL_IVY_DIR
$(error GLOBAL_IVY_DIR is not set. Typically ~/.ivy2)
endif

# absolute path to the prepopulated sbt-boot directory
ifndef GLOBAL_SBT_BOOT_DIR
$(error GLOBAL_SBT_BOOT_DIR is not set. Typically ~/.sbt/boot)
endif

# level of concurrency
ifndef N_JOBS
$(error N_JOBS is not set. Controls the number of parallel jobs)
endif

SBT_MEM ?= 16000
TIMEOUT ?= 120m
MAX_MEM ?= 128000

MAX_REPEAT := 3
ANALYSIS_DIR := _analysis_
SCRIPTS_DIR := $(base_dir)scripts
IVY_DIR := .ivy
SBT_BOOT_DIR := .sbt-boot
SCALAMETA_VERSION := 4.1.0
REPO_METADATA := $(ANALYSIS_DIR)/repo-metadata.csv
REPO_SLOC := $(ANALYSIS_DIR)/repo-sloc.csv

PROJECTS_GITHUB_INFO := projects-github-info.csv


METADATA_STATUS := $(ANALYSIS_DIR)/metadata-status.csv
METADATA_LOG := $(ANALYSIS_DIR)/metadata.log

COMPILE_STATUS := $(ANALYSIS_DIR)/compile-status.csv
COMPILE_LOG := $(ANALYSIS_DIR)/compile.log

SEMANTICDB_STATUS := $(ANALYSIS_DIR)/semanticdb-status.csv
SEMANTICDB_LOG := $(ANALYSIS_DIR)/semanticdb.log
MERGED_SEMANTICDB_FILE := $(ANALYSIS_DIR)/semanticdb-$(SCALAMETA_VERSION).bin
MERGED_SEMANTICDB_STATS_FILE := $(ANALYSIS_DIR)/semanticdb-stats-$(SCALAMETA_VERSION).csv

GLOBAL_IMPLICITS := implicits.bin
IMPLICITS := $(ANALYSIS_DIR)/implicits.bin
IMPLICITS_STATUS := $(ANALYSIS_DIR)/implicits-status.csv
IMPLICITS_STATS := $(ANALYSIS_DIR)/implicits-stats.csv
IMPLICITS_LOG := $(ANALYSIS_DIR)/implicits.log
IMPLICITS_EXCEPTIONS := $(ANALYSIS_DIR)/implicits-exceptions.csv

#AMM := JAVA_OPTS="-Xmx$(MAX_MEM)m -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5050" amm
AMM := JAVA_OPTS="-Xmx$(MAX_MEM)m" amm

$(IVY_DIR):
	mkdir -p $(IVY_DIR)
	ln -sf $(GLOBAL_IVY_DIR)/cache $(IVY_DIR)
	ln -sf $(GLOBAL_IVY_DIR)/local $(IVY_DIR)

$(SBT_BOOT_DIR):
	mkdir -p $(SBT_BOOT_DIR)
	ls -1 $(GLOBAL_SBT_BOOT_DIR) |\
        grep "^scala-" |\
        parallel ln -sf "$(GLOBAL_SBT_BOOT_DIR)/{1}" "$(SBT_BOOT_DIR)/${1}"

