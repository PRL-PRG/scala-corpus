---
title: "Report"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: lumen
toc_depth: 3
editor_options: 
  chunk_output_type: console
params:
  base_dir: "/home/rstudio/work"
  current_dir: "/var/lib/scala/corpora/top100"
  file_view_prefix: "/files//home/rstudio/work/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(fs)
library(tidyverse)
library(DT)
library(glue)
library(ggplot2)

PROJECTS_DIR <- "projects"
ANALYSIS_DIR <- "_analysis_"

PROJECTS_FILE <- "projects.txt"

METADATA_STATUS <- "metadata-status.csv"
METADATA_SOURCEPATHS <- "metadata-sourcepaths.csv"
METADATA_LOG <- "metadata.log"

COMPILE_STATUS <- "compile-status.csv"
COMPILE_LOG <- "compile.log"

SDB_STATUS <- "semanticdb-status.csv"
SDB_STATS <- "semanticdb-stats.csv"
SDB_LOG <- "semanticdb.log"

IMPLICITS_STATUS <- "implicits-status.csv"
IMPLICITS_STATS <- "implicits-stats.csv"
IMPLICITS_EXCEPTIONS <- "implicits-exceptions.csv"
IMPLICITS_LOG <- "implicits.log"
```

```{r aux, include=FALSE}
add_prefix <- function(prefix) function(x) str_c(prefix, '_', x)

merge_project_csvs <- function(project_ids, files, col_types) {
  stopifnot(length(project_ids) == length(files))
  
  existing_files <- file_exists(files)

  df <- map2_dfr(
    project_ids[existing_files], 
    files[existing_files], 
    ~mutate(read_csv(.y, col_types=col_types), project_id=.x)
  )
  
  if (nrow(df) == 0) {
    data_frame(project_id=character())
  } else {
    select(df, project_id, everything())
  }
}

projects_file <- function(projects, filename) path(params$current_dir, PROJECTS_DIR, projects, ANALYSIS_DIR, filename)

show_dataframe <- function(table) {
  datatable(
    table,
    class='cell-border stripe',
    options=list(pageLength=100),
    escape=FALSE
  )
}

show_task_exit_code_summary <- function(status) {
  count(status, exit_code) %>% 
    knitr::kable()
}

show_task_failed_projects <- function(status) {
  status %>%
  filter(exit_code != 0) %>%
  .$project_id %>%
  cat(sep = "\n")
}

create_link <- Vectorize(function(href, text) {
  glue("<a href='{href}' target='_blank'>{text}</a>")
})

add_project_html_links <- function(df) {
  mutate(
    df, 
    project_id=create_link(origin, project_id), 
    project_path=create_link(
      str_c(params$file_view_prefix, project_path),
      basename(project_path)
    )
  )
}

add_log_html_links <- function(df) {
  mutate_at(df, vars(ends_with("log_file")), function(x) create_link(str_c(params$file_view_prefix, path_rel(x, params$base_dir)), basename(x)))
}

add_html_links <- function(df) {
  df %>%
  add_project_html_links() %>%
  add_log_html_links()
}

show_task_all_project_status <- function(df) {
  add_html_links(df) %>%
  select(
    -origin
  ) %>% 
    show_dataframe()
}
```


```{r}
project_ids <- read_lines(path(params$current_dir, PROJECTS_FILE))
projects <- data_frame(
    project_id=project_ids,
    origin=str_c("https://github.com/", str_replace(project_id, "--", "/")),
    project_path=path(params$current_dir, PROJECTS_DIR, project_id)
)
```

```{r}
metadata_status <- read_csv(path(params$current_dir, METADATA_STATUS), col_types="cii")
metadata_sourcepaths <- read_csv(path(params$current_dir, METADATA_SOURCEPATHS), col_types="ccclciciii")
compile_status <- read_csv(path(params$current_dir, COMPILE_STATUS), col_types="ciii")
sdb_status <- read_csv(path(params$current_dir, SDB_STATUS), col_types="ciii")
sdb_stats <- read_csv(path(params$current_dir, SDB_STATS), col_types="ciiii")
implicits_status <- read_csv(path(params$current_dir, IMPLICITS_STATUS), col_types="cii")
implicits_stats <- read_csv(path(params$current_dir, IMPLICITS_STATS), col_types="cciiiii")
```

```{r}
projects <- local({
  w_metadata <- left_join(
    projects,
    rename_at(metadata_status, vars(-project_id), add_prefix('metadata')),
    by="project_id"
  )
  
  w_compile <- left_join(
    w_metadata,
    rename_at(compile_status, vars(-project_id), add_prefix('compile')),
    by="project_id"
  )
  
  w_sdb <- left_join(
    w_compile,
    rename_at(sdb_status, vars(-project_id), add_prefix('sdb')),
    by="project_id"
  )
  
  w_sdb_stats <- left_join(
    w_sdb,
    rename_at(sdb_stats, vars(-project_id), add_prefix('sdb')),
    by="project_id"
  )
  
  w_implicits <- left_join(
    w_sdb_stats,
    rename_at(implicits_status, vars(-project_id), add_prefix('implicits')),
    by="project_id"
  )
  
  w_implicits_stats <- left_join(
    w_implicits,
    select(
      implicits_stats, 
      project_id, 
      declarations, 
      callsites, 
      implicit_declarations,
      implicit_callsites,
      implicit_failure=failure, 
      implicit_problems=failures
    ),
    by="project_id"
  )
  
  w_implicits_stats
})
```

# Task summary

## Metadata

### Exit code

```{r}
metadata_status %>% show_task_exit_code_summary()
```

### Failed projects

```{r comment=NA}
metadata_status %>% show_task_failed_projects()
```

## Compile

### Exit code

```{r}
compile_status %>% show_task_exit_code_summary()
```

### Failed projects

```{r comment=NA}
compile_status %>% show_task_failed_projects()
```

## Semanticdb

### Exit code

```{r}
sdb_status %>% show_task_exit_code_summary()
```

### Failed projects

```{r comment=NA}
sdb_status %>% show_task_failed_projects()
```

## Implicits

### Exit code

```{r}
implicits_status %>% show_task_exit_code_summary()
```

### Failed projects

```{r comment=NA}
implicits_status %>% show_task_failed_projects()
```

## Problems with corpus

### Failed semanticdb generation, but compiled

```{r}
failed_sdb_compiled <- filter(projects, sdb_exit_code != 0, compile_exit_code == 0) %>% select(project_id)
failed_sdb_compiled
```

### Failed metadata, but compiled

```{r}
failed_metadata_compiled <- filter(projects, metadata_exit_code != 0, compile_exit_code == 0) %>% select(project_id)
failed_metadata_compiled
```

### Failed metadata, but generated semanticdb

```{r}
failed_metadata_sdb <- filter(projects, metadata_exit_code != 0, sdb_exit_code == 0) %>% select(project_id)
failed_metadata_sdb
```

### Different number of compile classes between compile and semanticdb

```{r}
different_class_number <- 
  filter(projects, sdb_exit_code == 0, compile_exit_code == 0, sdb_classes != compile_classes) %>% 
  select(project_id, sdb_classes, compile_classes) %>% 
  mutate(diff=sdb_classes-compile_classes)

different_class_number
```

### No semanticdb files, but compiled classes

```{r}
no_sdb_files_compiled <- filter(projects, sdb_files == 0, sdb_exit_code == 0, sdb_classes > 0)
no_sdb_files_compiled
```

## Problems with implicit extraction

```{r}
exceptions <- read_csv(path(params$current_dir, IMPLICITS_EXCEPTIONS), col_types="ccccc")
```

```{r}
classified_exceptions <- 
  mutate(
    exceptions,
    class=case_when(
      cause == "MissingSymbolException" & str_detect(message, "symbol: local\\d+") ~ "missing-local-symbol",
      cause == "MissingSymbolException" & str_detect(message, "at Range\\(\\d+,\\d+,\\d+,\\d+\\)") ~ "missing-symbol-at-range",
      cause == "MissingSymbolException" ~ "missing-symbol-other",
      cause == "LoadingMetadataException" & str_detect(message, "No module found") & str_detect(message, "multi-jvm") ~ "missing-module-multijvm",
      cause == "LoadingMetadataException" & str_detect(message, "No module found") ~ "missing-module",
      cause == "LoadingMetadataException" ~ "metadata-loading",
      cause == "NotImplementedError" ~ "not-implemented",
      cause == "UnexpectedElementException" ~ "unexpected-element",
      cause == "UnsupportedElementException" ~ "unsupported-element",
      TRUE ~ "unclassified"
    )
  )
```


### Per project summary

```{r}
count(classified_exceptions, project_id) %>% arrange(desc(n)) %>% datatable()
```

### Per exception summary

```{r}
count(classified_exceptions, cause) %>% arrange(desc(n)) %>% datatable()
```

### Per class summary

```{r}
count(classified_exceptions, class) %>% arrange(desc(n)) %>% datatable()
```

### Per project and class summary

```{r}
count(classified_exceptions, project_id, class) %>% arrange(desc(n)) %>% datatable()
```

### Missing local symbols

```{r}
filter(classified_exceptions, class=="missing-local-symbol") %>% count(project_id) %>% arrange(desc(n)) %>% datatable()
```

#### Missing symbols at range

```{r}
filter(classified_exceptions, class=="missing-symbol-at-range") %>% count(project_id) %>% arrange(desc(n)) %>% datatable()
```

#### Missing other symbols

```{r}
filter(classified_exceptions, class=="missing-symbol-other") %>% count(project_id) %>% arrange(desc(n)) %>% datatable()
```

#### Per project and symbol

```{r}
filter(classified_exceptions, class=="missing-symbol-other") %>% 
  transmute(project_id, symbol=str_replace_all(message, ".*symbol: (.*)$", "\\1")) %>%
  count(project_id, symbol) %>% 
  arrange(desc(n)) %>% 
  datatable()
```

### Unclassified

```{r}
uncategorized_exceptions <- filter(classified_exceptions, class=="unclassified")
```

#### List

```{r}
uncategorized_exceptions %>% select(project_id, module_id, message) %>% datatable()
```

#### Per project

```{r}
uncategorized_exceptions %>% count(project_id) %>% arrange(desc(n)) %>% datatable()
```

### Implicits failures - the extraction process itself failed

```{r}
implicits_stats %>% filter(!is.na(failure)) %>% select(project_id, failure) %>% datatable()
```

## Implicits stats

### Summary

```{r}
implicits_stats %>% summarise_at(
  vars(
    declarations, 
    callsites, 
    implicit_declarations, 
    implicit_callsites, 
    failures
  ), 
  sum
) %>% datatable()
```

### Graph

```{r}
projects_scala_sloc <- 
  filter(metadata_sourcepaths, language=="Scala") %>%
  select(project_id, code) %>%
  group_by(project_id) %>%
  summarise_all(sum)

implicits_stats_w_code <- left_join(
  implicits_stats, 
  projects_scala_sloc, 
  by="project_id"
)
```

```{r}
is_outlier <- function(x) {
  x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x)
}
```

```{r}
show_implicits_stat_code <- function(var) {
  implicits_stats_w_code %>%
  mutate(
    label=if_else(is_outlier(!!var), project_id, as.character(NA))
  ) %>%
  ggplot(aes(x=code, y=!!var)) + 
    geom_point() +
    geom_label(aes(label = label), na.rm = TRUE, hjust = -0.3)
}
```

```{r}
show_implicits_stat_code(quo(implicit_callsites))
```

```{r}
show_implicits_stat_code(quo(implicit_declarations))
```

```{r}
show_implicits_stat_code(quo(callsites))
```

```{r}
show_implicits_stat_code(quo(declarations))
```

```{r}
show_implicits_stat_code(quo(failures))
```

```{r}
show_implicits_stat_box <- function(var) {
  implicits_stats_w_code %>%
  mutate(
    label=if_else(is_outlier(!!var), project_id, as.character(NA))
  ) %>%
  ggplot(aes(x=quo_name(var), y=!!var)) +
    geom_boxplot() +
    geom_label(aes(label = label), na.rm = TRUE, hjust = -0.3)
}
```

```{r}
show_implicits_stat_box(quo(implicit_callsites))
```

```{r}
show_implicits_stat_box(quo(implicit_declarations))
```

```{r}
show_implicits_stat_box(quo(callsites))
```

```{r}
show_implicits_stat_box(quo(declarations))
```

```{r}
show_implicits_stat_box(quo(code))
```

```{r}
show_implicits_stat_box(quo(failures))
```

